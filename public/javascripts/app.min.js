$(function(){function e(){s=document.createElement("div"),$("#heart")[0].appendChild(s),p=new THREE.PerspectiveCamera(50,b/x,1,1e3),p.position.set(0,150,700),l=new THREE.Scene,h=new THREE.Group,l.add(h);var e="I Love You",t=new THREE.TextGeometry(e,{size:60,height:20,curveSegments:2,font:"helvetiker"});t.computeBoundingBox();var n=-.5*(t.boundingBox.max.x-t.boundingBox.min.x),a=new THREE.MeshBasicMaterial({color:16777215*Math.random(),overdraw:.5});g=new THREE.Mesh(t,a),g.position.x=n,g.position.y=100,g.position.z=0,g.rotation.x=0,g.rotation.y=2*Math.PI,h.add(g),m=new THREE.Object3D,m.y=800,h.add(m);var o=0,r=0;w=new THREE.Shape,w.moveTo(o+25,r+25),w.bezierCurveTo(o+25,r+25,o+20,r,o,r),w.bezierCurveTo(o-30,r,o-30,r+35,o-30,r+35),w.bezierCurveTo(o-30,r+55,o-10,r+77,o+25,r+95),w.bezierCurveTo(o+60,r+77,o+80,r+55,o+80,r+35),w.bezierCurveTo(o+80,r+35,o+80,r,o+50,r),w.bezierCurveTo(o+35,r,o+25,r+25,o+25,r+25);var d=0,v=function(e){e.globalAlpha=.5;var i=0,t=0;e.scale(.05,-.05),e.beginPath(),e.bezierCurveTo(i+2.5,t+2.5,i+2,t,i,t),e.bezierCurveTo(i-3,t,i-3,t+3.5,i-3,t+3.5),e.bezierCurveTo(i-3,t+5.5,i-1,t+7.7,i+2.5,t+9.5),e.bezierCurveTo(i+6,t+7.7,i+8,t+5.5,i+8,t+3.5),e.bezierCurveTo(i+8,t+3.5,i+8,t,i+5,t),e.bezierCurveTo(i+3.5,t,i+2.5,t+2.5,i+2.5,t+2.5),e.fill(),e.lineWidth=.5,e.stroke()},f=function(){var e=new THREE.SpriteCanvasMaterial({program:v});return e.color.setHSL(d,1,.75),d+=.001,d>1&&(d-=1),particle=new THREE.Sprite(e),particle.scale.x=particle.scale.y=40*Math.random()+40,m.add(particle),particle},T=function(e){e.target.position.copy(e.position)},E=function(e){e.target.visible=!1,m.remove(e.target)};u=new SPARKS.Emitter(new SPARKS.SteadyCounter(160)),emitterpos=new THREE.Vector3,u.addInitializer(new SPARKS.Position(new SPARKS.PointZone(emitterpos))),u.addInitializer(new SPARKS.Lifetime(0,2)),u.addInitializer(new SPARKS.Target(null,f)),u.addInitializer(new SPARKS.Velocity(new SPARKS.PointZone(new THREE.Vector3(0,-50,10)))),u.addAction(new SPARKS.Age),u.addAction(new SPARKS.Move),u.addAction(new SPARKS.RandomDrift(50,50,2e3)),u.addCallback("created",T),u.addCallback("dead",E),u.addCallback("updated",function(e){e.target.position.copy(e.position)}),u.start(),c=new THREE.CanvasRenderer,c.setClearColor(15790320),c.setPixelRatio(window.devicePixelRatio),c.setSize(window.innerWidth,window.innerHeight),s.appendChild(c.domElement),window.addEventListener("resize",i,!1)}function i(){p.aspect=window.innerWidth/window.innerHeight,p.updateProjectionMatrix(),c.setSize(window.innerWidth,window.innerHeight)}function t(){requestAnimationFrame(t),n()}function n(){f+=.0337,f>1&&(f-=1);var e=w.getPointAt(f);emitterpos.x=5*e.x-100,emitterpos.y=5*-e.y+400,m.rotation.y+=.02,h.rotation.y+=.05*(v-h.rotation.y),c.render(l,p)}function a(){var e=Date.parse("Jan 1, 2015"),i=(new Date).getTime(),t=(i-e)/1e3,n=Math.floor(t/86400);t%=86400;var a=Math.floor(t/3600);10>a&&(a="0"+a),t%=3600;var o=Math.floor(t/60);10>o&&(o="0"+o),t=Math.floor(t%60),10>t&&(t="0"+t);var r=" "+n+" 天 "+a+" 小时 "+o+" 分 "+t+" 秒";$("#section1 span").html(r)}function o(e,i){function t(){T=new AMap.Marker({map:d,position:new AMap.LngLat(a[0].lng,a[0].lat),icon:"http://7vijjg.com1.z0.glb.clouddn.com/move.jpg",offset:new AMap.Pixel(-26,-13),autoRotation:!0}),E=new Array;for(var e=a.length,t=0;e>t;t++)E.push(new AMap.LngLat(a[t].lng,a[t].lat));for(var t=0;e>t;t++)r(d,a,t);new AMap.Polyline({map:d,path:E,strokeColor:"#00a",strokeOpacity:1,strokeWeight:2,strokeStyle:"solid"});d.setFitView(),function(e,i,t){$("#slide"+i+" input:first-child").on("click",function(){e.moveAlong(t,2e3)}),$("#slide"+i+" input:last-child").on("click",function(){e.stopMove()})}(T,i,E)}var n="#slide"+i;$(n+" h1").html(e.date);var a=e.path,o="mapContainer"+i,d=new AMap.Map(o,{resizeEnable:!0,view:new AMap.View2D({center:new AMap.LngLat(a[0].lng,a[0].lat),zoom:17}),continuousZoomEnable:!1});AMap.event.addListener(d,"complete",t)}function r(e,i,t){new AMap.Marker({map:e,position:new AMap.LngLat(i[t].lng,i[t].lat),icon:"http://7vijjg.com1.z0.glb.clouddn.com/marker.png",title:i[t].name})}function d(e){var i='<li><img src="'+phd[e].small+'", data-img="'+phd[e].large+'", alt="'+phd[e].description+'">';i+="<div><p>"+phd[e].description+"</p></div>",i+="</li>",R.append(i)}$("#fullpage").fullpage({sectionsColor:["#eae1c0","#4bbfc3","#8fb98b","#de564b","#e5e6d0"],css3:!0,scrollOverflow:!0,navigation:!0,navigationTooltips:["正如初次见到你那样的心跳","我们共同走过的时间","我们一起去过的地方","我们留下的那些回忆","来给我们留言吧"],slidesNavigation:!0,slidesNavTooltips:["2014/11/16","2014/12/07","2014/12/13","2014/12/14","2014/12/31"]});var s,p,l,c,h,g,w,m,u,v=0,f=0,b=window.innerWidth,x=window.innerHeight;e(),t(),a(),setInterval(function(){a()},1e3);for(var T,E,A=mapData.map,S=A.length,z=0;S>z;z++)o(A[z],z);!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",e.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();var R=$("#iw_thumbs"),y=$("#iw_ribbon"),M=y.children("span.iw_close"),C=y.children("span.iw_zoom");phd=photoData.photo,phLen=phd.length;for(var P=0;P<phLen;P++)d(P);var H=function(){var e,i=-1,t=!1,n=!1,a={speed:500,easing:"easeOutExpo"},o={speed:400,easing:"swing"},r=function(){R.imagesLoaded(function(){R.masonry({isAnimated:!0})}),d(),s()},d=function(){e={width:$(window).width(),height:$(window).height()}},s=function(){R.delegate("li","click",function(){if(y.is(":animated"))return!1;var e=$(this);e.data("ribbon")?h(e):t||(t=!0,e.data("ribbon",!0),i=e.index(),p(e))}),M.bind("click",l),$(window).bind("resize",function(){return d(),y.is(":animated")?!1:void l()}).bind("scroll",function(){return y.is(":animated")?!1:void l()})},p=function(i){var t=i.children("img"),n=t.next();R.children("li").not(i).animate({opacity:.2},o.speed),t.css("z-index",100).data("originalHeight",t.height()).stop().animate({height:"100px"},o.speed,o.easing);var r,d,s={top:i.offset().top-$(window).scrollTop()-6+"px"};i.offset().left<e.width/2?(d="left",s.left=0,s.right="auto"):(d="right",s.right=0,s.left="auto"),y.css(s).show().stop().animate({width:"100%"},a.speed,a.easing,function(){switch(d){case"left":r={left:t.outerWidth(!0)+"px","text-align":"left"};break;case"right":r={left:"-200px","text-align":"right"}}n.css(r).fadeIn(),M.show(),C.show()})},l=function(){if(t=!1,M.hide(),C.hide(),n)y.stop().animate({opacity:.8,height:"0px",marginTop:e.height/2+"px"},a.speed,function(){y.css({width:"0%",height:"126px","margin-top":"0px"}).children("img").remove()}),n=!1;else{var o=R.children("li").eq(i);c(o),y.stop().animate({width:"0%"},a.speed,a.easing)}},c=function(e){var i=e.children("img"),t=i.next();e.data("ribbon",!1),i.css("z-index",1).stop().animate({height:i.data("originalHeight")},o.speed,o.easing),t.fadeOut(),R.children("li").not(e).animate({opacity:1},o.speed)},h=function(e){n=!0,M.hide();var i=e.children("img"),t=i.data("img"),o=$('<span class="iw_loading"></span>');e.append(o),$("<img/>").load(function(){var i=$(this);o.remove(),C.hide(),g(i),c(e),y.stop().animate({opacity:1,height:"0px",marginTop:"63px"},a.speed,function(){y.prepend(i),M.show(),y.animate({height:"100%",marginTop:"0px",top:"0px"},a.speed)})}).attr("src",t)},g=function(i){var t=100,n=100,a=e.height-n,o=e.width-t,r=new Image;r.src=i.attr("src");var d=r.width,s=r.height;if(d>o||s>a)if(d>s){var p=o,l=d/o,c=s/l;if(r.height=c,r.width=p,c>a){var h=a,g=c/a,w=p/g;r.width=w,r.height=h}}else{var c=a,l=s/a,p=d/l;if(r.height=c,r.width=p,p>o){var w=o,g=p/o,h=c/g;r.height=h,r.width=w}}i.css({width:r.width+"px",height:r.height+"px","margin-left":-r.width/2+"px","margin-top":-r.height/2+"px"})};return{init:r}}();H.init()});